<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>혼테일 브레이커</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- 구글 애드센스 스크립트 -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8602495420447615" crossorigin="anonymous"></script>

    <style>
        @keyframes shine {
            to { background-position: 200% center; }
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
        }
        .main-title-container {
            text-align: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
        }
        .main-title {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(90deg, #d4af37, #ffd700, #e6bf4a, #ffd700, #d4af37);
            background-size: 200% auto;
            color: #000;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 8s linear infinite;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            display: inline-block;
        }
        .main-title:hover {
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 30px rgba(255, 215, 0, 0.6);
            transform: scale(1.02);
        }
        .sub-title {
            font-size: 1.25rem;
            color: #a0aec0;
            margin-top: 0.5rem;
        }
        .card {
            background-color: #1e1e1e;
            border-radius: 0.5rem;
            border: 1px solid #444;
        }
        .card-content {
            padding: 1.5rem;
        }
        .input-field {
            background-color: #2a2a2a;
            border: 1px solid #555;
            color: #e0e0e0;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: all 0.2s;
        }
        textarea.input-field { resize: vertical; }
        .input-field:focus { outline: none; border-color: #ffd700; background-color: #333; }
        .input-field:disabled { background-color: #222; color: #777; cursor: not-allowed; }
        .btn {
            background-color: #333; color: #ffd700; font-weight: 600; padding: 0.75rem 1rem;
            border-radius: 0.375rem; cursor: pointer; border: 1px solid #ffd700; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; text-align: center;
        }
        .btn:hover:not(:disabled) { background-color: #ffd700; color: #121212; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .btn:disabled { background-color: #2a2a2a; color: #666; border-color: #444; cursor: not-allowed; }
        .btn.active { background-color: #e53e3e; color: white; border-color: #e53e3e; }
        .btn-danger { background-color: #8B0000; border-color: #ff6b6b; color: #ff6b6b; }
        .btn-danger:hover:not(:disabled) { background-color: #ff6b6b; color: #121212; }
        .lang-btn.active {
            background-color: #ffd700;
            color: #121212;
            font-weight: 700;
        }
        .section-title { 
            font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; padding-bottom: 0.5rem;
            text-align: center; color: #ffd700; border-bottom: 1px solid #ffd700;
        }
        .party-list { min-height: 200px; flex-grow: 1; }
        .draggable-item {
            display: flex; align-items: center; justify-content: space-between;
            background-color: #2a2a2a; padding: 0.75rem; margin-bottom: 0.5rem;
            border-radius: 0.375rem; border-left: 4px solid #ffd700; cursor: grab; user-select: none;
        }
        .sortable-ghost { opacity: 0.4; background: #444; }
        .btn-death {
            background-color: transparent; color: #ff6b6b; padding: 0.1rem 0.5rem; font-size: 0.8rem;
            border: 1px solid #ff6b6b; border-radius: 4px;
        }
        .btn-death:hover:not(:disabled) { background-color: #ff6b6b; color: #121212; }
        .btn-death:disabled { color: #666; border-color: #444; background-color: #2a2a2a; }
        .death-timer-display { font-size: 0.9rem; font-weight: bold; color: #ff8e8e; margin-left: 0.5rem; width: 50px; text-align: right; }
        #copy-feedback { transition: opacity 0.3s; color: #68d391; }
        .time-display { font-size: 1.25rem; font-weight: 700; }

        /* Accordion Styles */
        .accordion-header {
            cursor: pointer;
            padding: 1rem 1.5rem;
            background-color: #2a2a2a;
            border-bottom: 1px solid #444;
            transition: background-color 0.2s;
        }
        .accordion-header:hover { background-color: #333; }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .accordion-icon { transition: transform 0.3s ease-out; }
        .accordion-header.active .accordion-icon { transform: rotate(180deg); }
    </style>
</head>
<body class="p-4">

    <div class="w-full max-w-screen-2xl mx-auto space-y-8">
        <div class="main-title-container">
            <h1 class="main-title" data-lang="main_title">혼테일 브레이커</h1>
            <p class="sub-title">by 소년아서</p>
        </div>

        <!-- 언어 변경 버튼 -->
        <div class="flex justify-center gap-2 mb-4">
            <button id="lang-ko" class="btn lang-btn">한국어</button>
            <button id="lang-en" class="btn lang-btn">English</button>
            <button id="lang-ja" class="btn lang-btn">日本語</button>
        </div>
        
        <!-- 상단 광고 영역 -->
        <div class="text-center">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-8602495420447615"
                 data-ad-slot="1234567890" 
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
        
        <div class="card p-4">
            <div class="flex flex-col md:flex-row justify-around items-center text-center gap-4">
                <div>
                    <h3 class="font-bold text-xl text-gray-400 mb-2" data-lang="current_time">현재 시간</h3>
                    <p id="browser-clock" class="text-3xl font-mono"></p>
                </div>
                <div>
                    <h3 class="font-bold text-xl text-gray-400 mb-2" data-lang="horntail_timer">혼테일 제한시간</h3>
                    <p id="countdown-12h-display" class="text-3xl font-mono text-yellow-400">12시간 00분 00초</p>
                    <button id="start-12h-countdown" class="btn w-48 mt-2 text-md p-2 rounded" data-lang="start_btn">시작</button>
                </div>
            </div>
        </div>

        <!-- Accordion Container -->
        <div class="space-y-4">
            <!-- 공대장용 유틸 -->
            <div class="card accordion-item">
                <div class="accordion-header flex justify-between items-center" data-target="#leader-utils">
                    <h2 class="text-2xl font-bold text-yellow-400" data-lang="leader_utils">🛡️ 공대장용 유틸</h2>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <div id="leader-utils" class="accordion-content">
                    <div class="card-content grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h2 class="section-title" data-lang="gongmu_timer">⚔️ 혼테일 공무 타이머</h2>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <button id="timer-p1" class="btn timer-btn flex-col h-24"><span class="font-bold text-lg" data-lang="phase1_left">1페이즈 (좌)</span><span class="time-display" data-time="45">45초</span></button>
                                <button id="timer-p2" class="btn timer-btn flex-col h-24"><span class="font-bold text-lg" data-lang="phase2_right">2페이즈 (우)</span><span class="time-display" data-time="45">45초</span></button>
                            </div>
                            <div class="mt-auto border-t-2 border-dashed border-gray-600 pt-4">
                                <h3 class="text-center font-bold mb-2 text-yellow-400" data-lang="phase3">3페이즈</h3>
                                <div class="grid grid-cols-2 gap-4 mb-2">
                                    <button id="timer-left" class="btn timer-btn flex-col h-24"><span class="font-bold text-3xl">L</span><span class="font-semibold" data-lang="left_head">좌머리</span><span class="time-display" data-time="45">45초</span></button>
                                    <button id="timer-right" class="btn timer-btn flex-col h-24"><span class="font-bold text-3xl">R</span><span class="font-semibold" data-lang="right_head">우머리</span><span class="time-display" data-time="45">45초</span></button>
                                </div>
                                <button id="timer-center" class="btn timer-btn w-full flex-col h-24"><span class="font-bold text-3xl">C</span><span class="font-semibold" data-lang="center_head">중앙머리</span><span class="time-display" data-time="45">45초</span></button>
                            </div>
                        </div>
                        <div>
                            <h2 class="section-title" data-lang="debuff_timer_title">✨ 버프해제(갈) 타이머</h2>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <button id="buff-5m" class="btn timer-btn flex-col h-28"><span class="font-bold text-4xl">5</span><span class="font-semibold" data-lang="5min_debuff">5분갈</span><span class="time-display" data-time="300">5:00</span></button>
                                <button id="buff-3m" class="btn timer-btn flex-col h-28"><span class="font-bold text-4xl">3</span><span class="font-semibold" data-lang="3min_debuff">3분갈</span><span class="time-display" data-time="180">3:00</span></button>
                            </div>
                            <button id="buff-restart" class="btn w-full text-lg mb-6" data-lang="simul_restart">동시 재시작</button>
                            <div class="space-y-4 mt-auto">
                                <h3 class="text-xl font-bold text-center" data-lang="debuff_expire_time">버프 해제 시간</h3>
                                <div class="flex justify-between items-center p-3 bg-black/20 rounded-md"><span>5분:</span><span id="buff-5m-expire" class="font-bold">--:--:--</span></div>
                                <div class="flex justify-between items-center p-3 bg-black/20 rounded-md"><span>3분:</span><span id="buff-3m-expire" class="font-bold">--:--:--</span></div>
                            </div>
                        </div>
                        <div class="md:col-span-2 mt-4 border-t border-gray-700 pt-4">
                             <button id="reset-all-timers" class="btn btn-danger w-full" data-lang="reset_all_timers">공무/버프 타이머 전체 초기화</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 비숍용 유틸 -->
            <div class="card accordion-item">
                <div class="accordion-header flex justify-between items-center" data-target="#bishop-utils">
                    <h2 class="text-2xl font-bold text-yellow-400" data-lang="bishop_utils">💖 비숍용 유틸</h2>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <div id="bishop-utils" class="accordion-content">
                    <div class="card-content">
                        <h2 class="section-title" data-lang="resurrection_management">리저렉션 관리</h2>
                        <div class="flex items-center justify-center gap-4 mb-6">
                            <span class="font-semibold" data-lang="resurrection_count">리저렉션 갯수:</span>
                            <button id="res-minus" class="btn w-10 h-10 text-2xl font-bold">-</button>
                            <span class="text-2xl font-bold w-10 text-center text-yellow-400" id="res-count">4</span>
                            <button id="res-plus" class="btn w-10 h-10 text-2xl font-bold">+</button>
                        </div>
                        <div id="res-timers-container" class="space-y-3 max-w-lg mx-auto"></div>
                        <button id="reset-res-timers" class="btn btn-danger max-w-lg w-full mt-6 mx-auto flex" data-lang="reset_res_timers">리저렉션 전체 초기화</button>
                    </div>
                </div>
            </div>
            
            <!-- 파티 명단 관리 -->
            <div class="card accordion-item">
                <div class="accordion-header flex justify-between items-center" data-target="#party-manager">
                    <h2 class="text-2xl font-bold" data-lang="party_management">📋 파티 명단 관리</h2>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <div id="party-manager" class="accordion-content">
                    <div class="card-content">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                            <div class="flex items-center gap-4">
                                <div class="flex items-center justify-center gap-2">
                                    <span class="font-semibold" data-lang="party_count">파티 수:</span>
                                    <button id="party-minus-btn" class="btn w-10 h-10 text-xl font-bold">-</button>
                                    <span id="party-count-display" class="text-2xl font-bold w-8 text-center text-yellow-400">4</span>
                                    <button id="party-plus-btn" class="btn w-10 h-10 text-xl font-bold">+</button>
                                </div>
                            </div>
                            <div>
                                <button id="copy-list-btn" class="btn" data-lang="copy_party_list">파티 명단 복사</button>
                                <span id="copy-feedback" class="font-bold ml-2 opacity-0" data-lang="copy_feedback">복사 완료!</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div class="md:col-span-1 flex flex-col">
                                <h3 class="font-bold text-lg mb-2 text-center" data-lang="waiting_list">대기 명단</h3>
                                <textarea id="party-list-input" rows="8" class="input-field mb-2" data-lang-placeholder="paste_list_placeholder"></textarea>
                                <div class="grid grid-cols-2 gap-2">
                                    <button id="generate-list-btn" class="btn w-full" data-lang="apply_btn">적용</button>
                                    <button id="reset-list-btn" class="btn btn-danger w-full" data-lang="reset_btn">초기화</button>
                                </div>
                                <div id="waiting-list" class="party-list mt-2"></div>
                            </div>
                            <div id="party-container" class="md:col-span-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 메모장 -->
            <div class="card accordion-item">
                <div class="accordion-header flex justify-between items-center" data-target="#memo-pad-container">
                    <h2 class="text-2xl font-bold" data-lang="memo_pad">📝 메모장</h2>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                <div id="memo-pad-container" class="accordion-content">
                    <div class="card-content">
                        <textarea id="memo-pad" class="input-field w-full h-full min-h-[200px]" data-lang-placeholder="memo_placeholder"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 언어 데이터 ---
            const translations = {
                ko: {
                    main_title: "혼테일 브레이커",
                    current_time: "현재 시간",
                    horntail_timer: "혼테일 제한시간",
                    start_btn: "시작",
                    leader_utils: "🛡️ 공대장용 유틸",
                    gongmu_timer: "⚔️ 혼테일 공무 타이머",
                    phase1_left: "1페이즈 (좌)",
                    phase2_right: "2페이즈 (우)",
                    phase3: "3페이즈",
                    left_head: "좌머리",
                    right_head: "우머리",
                    center_head: "중앙머리",
                    debuff_timer_title: "✨ 버프해제(갈) 타이머",
                    "5min_debuff": "5분갈",
                    "3min_debuff": "3분갈",
                    simul_restart: "동시 재시작",
                    debuff_expire_time: "버프 해제 시간",
                    reset_all_timers: "공무/버프 타이머 전체 초기화",
                    bishop_utils: "💖 비숍용 유틸",
                    resurrection_management: "리저렉션 관리",
                    resurrection_count: "리저렉션 갯수:",
                    reset_res_timers: "리저렉션 전체 초기화",
                    party_management: "📋 파티 명단 관리",
                    party_count: "파티 수:",
                    copy_party_list: "파티 명단 복사",
                    copy_feedback: "복사 완료!",
                    waiting_list: "대기 명단",
                    paste_list_placeholder: "명단 붙여넣기...",
                    apply_btn: "적용",
                    reset_btn: "초기화",
                    memo_pad: "📝 메모장",
                    memo_placeholder: "여기에 메모를 입력하세요...",
                    use_btn: "사용",
                    bishop_placeholder: "비숍",
                    death_btn: "다이",
                    party_title: "파티"
                },
                en: {
                    main_title: "Horntail Breaker",
                    current_time: "Current Time",
                    horntail_timer: "Horntail Time Limit",
                    start_btn: "Start",
                    leader_utils: "🛡️ Raid Leader Utils",
                    gongmu_timer: "⚔️ Horntail Attack Timers",
                    phase1_left: "Phase 1 (Left)",
                    phase2_right: "Phase 2 (Right)",
                    phase3: "Phase 3",
                    left_head: "Left Head",
                    right_head: "Right Head",
                    center_head: "Center Head",
                    debuff_timer_title: "✨ Dispel Timers",
                    "5min_debuff": "5min Dispel",
                    "3min_debuff": "3min Dispel",
                    simul_restart: "Simultaneous Restart",
                    debuff_expire_time: "Dispel Expiration Time",
                    reset_all_timers: "Reset All Attack/Dispel Timers",
                    bishop_utils: "💖 Bishop Utils",
                    resurrection_management: "Resurrection Management",
                    resurrection_count: "Resurrections:",
                    reset_res_timers: "Reset All Resurrections",
                    party_management: "📋 Party Management",
                    party_count: "Parties:",
                    copy_party_list: "Copy Party List",
                    copy_feedback: "Copied!",
                    waiting_list: "Waiting List",
                    paste_list_placeholder: "Paste member list...",
                    apply_btn: "Apply",
                    reset_btn: "Reset",
                    memo_pad: "📝 Memo Pad",
                    memo_placeholder: "Enter your memo here...",
                    use_btn: "Use",
                    bishop_placeholder: "Bishop",
                    death_btn: "Death",
                    party_title: "Party"
                },
                ja: {
                    main_title: "ホーンテイルブレイカー",
                    current_time: "現在時刻",
                    horntail_timer: "ホーンテイル制限時間",
                    start_btn: "スタート",
                    leader_utils: "🛡️ 遠征隊長用ユーティリティ",
                    gongmu_timer: "⚔️ ホーンテイル攻撃タイマー",
                    phase1_left: "1段階 (左)",
                    phase2_right: "2段階 (右)",
                    phase3: "3段階",
                    left_head: "左頭",
                    right_head: "右頭",
                    center_head: "中央頭",
                    debuff_timer_title: "✨ デバフ解除タイマー",
                    "5min_debuff": "5分散",
                    "3min_debuff": "3分散",
                    simul_restart: "同時再スタート",
                    debuff_expire_time: "デバフ解除時間",
                    reset_all_timers: "攻撃/デバフタイマー全体リセット",
                    bishop_utils: "💖 ビショップ用ユーティリティ",
                    resurrection_management: "リザレクション管理",
                    resurrection_count: "リザレクション数:",
                    reset_res_timers: "リザレクション全体リセット",
                    party_management: "📋 パーティーリスト管理",
                    party_count: "パーティー数:",
                    copy_party_list: "パーティーリストコピー",
                    copy_feedback: "コピー完了！",
                    waiting_list: "待機リスト",
                    paste_list_placeholder: "リストを貼り付け...",
                    apply_btn: "適用",
                    reset_btn: "リセット",
                    memo_pad: "📝 メモ帳",
                    memo_placeholder: "ここにメモを入力してください...",
                    use_btn: "使用",
                    bishop_placeholder: "ビショップ",
                    death_btn: "死亡",
                    party_title: "パーティー"
                }
            };

            let currentLang = 'ko';

            // --- 언어 변경 로직 ---
            const setLanguage = (lang) => {
                currentLang = lang;
                localStorage.setItem('language', lang);

                document.querySelectorAll('[data-lang]').forEach(el => {
                    const key = el.dataset.lang;
                    if (translations[lang] && translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
                
                document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                    const key = el.dataset.langPlaceholder;
                     if (translations[lang] && translations[lang][key]) {
                        el.placeholder = translations[lang][key];
                    }
                });

                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`lang-${lang}`).classList.add('active');

                // 동적으로 생성된 요소들 언어 업데이트
                updateResurrectionButtons();
                updatePartyLayout();
            };

            const timers = {};
            let resurrectionStates = {}; 
            const deathTimers = {};
            let countdown12hInterval;

            // --- 일반 타이머 및 시계 로직 ---
            const browserClockEl = document.getElementById('browser-clock');
            const countdown12hDisplay = document.getElementById('countdown-12h-display');
            const start12hBtn = document.getElementById('start-12h-countdown');
            setInterval(() => {
                browserClockEl.textContent = new Date().toLocaleTimeString('ko-KR', { hour12: false });
            }, 1000);
            start12hBtn.addEventListener('click', () => {
                if (countdown12hInterval) clearInterval(countdown12hInterval);
                const endTime = Date.now() + 12 * 60 * 60 * 1000;
                countdown12hInterval = setInterval(() => {
                    const diff = endTime - Date.now();
                    if (diff <= 0) {
                        clearInterval(countdown12hInterval);
                        countdown12hDisplay.textContent = "0시간 00분 00초";
                        return;
                    }
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff / 1000 / 60) % 60);
                    const seconds = Math.floor((diff / 1000) % 60);
                    
                    let timeString;
                    if (currentLang === 'ko') {
                        timeString = `${hours}시간 ${String(minutes).padStart(2, '0')}분 ${String(seconds).padStart(2, '0')}초`;
                    } else if (currentLang === 'en') {
                        timeString = `${hours}h ${String(minutes).padStart(2, '0')}m ${String(seconds).padStart(2, '0')}s`;
                    } else { // ja
                         timeString = `${hours}時間 ${String(minutes).padStart(2, '0')}分 ${String(seconds).padStart(2, '0')}秒`;
                    }
                    countdown12hDisplay.textContent = timeString;

                }, 1000);
            });
            document.querySelectorAll('.timer-btn').forEach(button => {
                const id = button.id;
                const timerDisplay = button.querySelector('.time-display');
                if (!timerDisplay) return;
                const initialSeconds = parseInt(timerDisplay.dataset.time, 10);
                button.addEventListener('click', () => {
                    if (timers[id]) clearInterval(timers[id].interval);
                    if (timers[id] && timers[id].button) timers[id].button.classList.remove('active');
                    
                    button.classList.add('active');
                    const endTime = Date.now() + initialSeconds * 1000;

                    if (id.includes('buff')) {
                        document.getElementById(`${id}-expire`).textContent = new Date(endTime).toLocaleTimeString('ko-KR', { hour12: false });
                    }

                    timers[id] = {
                        endTime, initialSeconds, display: timerDisplay, button,
                        interval: setInterval(() => {
                            const diff = timers[id].endTime - Date.now();
                            if (diff <= 0) {
                                clearInterval(timers[id].interval);
                                timers[id].display.textContent = formatTime(timers[id].initialSeconds, id.includes('buff'));
                                timers[id].button.classList.remove('active');
                                delete timers[id];
                                return;
                            }
                            timers[id].display.textContent = formatTime(Math.ceil(diff / 1000), id.includes('buff'));
                        }, 100)
                    };
                });
            });
            document.getElementById('buff-restart').addEventListener('click', () => {
                document.getElementById('buff-5m').click();
                document.getElementById('buff-3m').click();
            });
            function formatTime(totalSeconds, isBuff) {
                if (isBuff || totalSeconds >= 60) {
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    return `${minutes}:${String(seconds).padStart(2, '0')}`;
                }
                return `${totalSeconds}${currentLang === 'ko' || currentLang === 'ja' ? '초' : 's'}`;
            }

            // --- 리저렉션 관리 로직 ---
            const resMinusBtn = document.getElementById('res-minus');
            const resPlusBtn = document.getElementById('res-plus');
            const resCountEl = document.getElementById('res-count');
            const resContainer = document.getElementById('res-timers-container');
            let resCount = 4;

            function loadResurrectionState() {
                const savedState = localStorage.getItem('resurrectionStates');
                if (savedState) {
                    resurrectionStates = JSON.parse(savedState);
                    Object.keys(resurrectionStates).forEach(key => {
                        if(resurrectionStates[key].interval) delete resurrectionStates[key].interval;
                    });
                }
                const savedCount = localStorage.getItem('resurrectionCount');
                resCount = savedCount ? parseInt(savedCount, 10) : 4;
                resCountEl.textContent = resCount;
            }

            function saveResurrectionState() {
                const stateToSave = JSON.parse(JSON.stringify(resurrectionStates));
                 Object.keys(stateToSave).forEach(key => {
                    delete stateToSave[key].interval;
                });
                localStorage.setItem('resurrectionStates', JSON.stringify(stateToSave));
                localStorage.setItem('resurrectionCount', resCount);
            }

            function updateResurrectionButtons() {
                resContainer.innerHTML = '';
                for (let i = 1; i <= resCount; i++) {
                    const resId = `res-${i}`;
                    
                    if (!resurrectionStates[resId]) {
                        resurrectionStates[resId] = { nickname: '', endTime: null, interval: null };
                    }
                    const state = resurrectionStates[resId];

                    const wrapper = document.createElement('div');
                    wrapper.className = 'flex items-center gap-2';
                    
                    const nicknameInput = document.createElement('input');
                    nicknameInput.type = 'text';
                    nicknameInput.placeholder = `${translations[currentLang].bishop_placeholder} ${i}`;
                    nicknameInput.className = 'input-field flex-grow';
                    nicknameInput.value = state.nickname || '';
                    nicknameInput.addEventListener('input', (e) => {
                        state.nickname = e.target.value;
                        saveResurrectionState();
                    });

                    const button = document.createElement('button');
                    button.id = resId;
                    button.className = 'btn text-lg w-40 flex-shrink-0';
                    
                    const expireEl = document.createElement('span');
                    expireEl.id = `${resId}-expire`;
                    expireEl.className = 'font-bold text-center w-28 flex-shrink-0';
                    
                    wrapper.append(nicknameInput, button, expireEl);
                    resContainer.appendChild(wrapper);

                    button.addEventListener('click', () => handleResurrectionClick(resId, button, expireEl, nicknameInput));

                    if (state.endTime && state.endTime > Date.now()) {
                        handleResurrectionClick(resId, button, expireEl, nicknameInput, true);
                    } else {
                        state.endTime = null;
                        button.textContent = translations[currentLang].use_btn;
                        expireEl.textContent = '--:--:--';
                    }
                }
                saveResurrectionState();
            }

            function handleResurrectionClick(resId, button, expireEl, nicknameInput, isRestart = false) {
                if (button.disabled && !isRestart) return;

                const state = resurrectionStates[resId];
                if (state.interval) clearInterval(state.interval);

                button.disabled = true;
                nicknameInput.disabled = true;
                
                if (!isRestart) {
                    state.endTime = Date.now() + 30 * 60 * 1000;
                    saveResurrectionState();
                }
                
                expireEl.textContent = new Date(state.endTime).toLocaleTimeString('ko-KR', { hour12: false });

                state.interval = setInterval(() => {
                    const diff = state.endTime - Date.now();
                    if (diff <= 0) {
                        clearInterval(state.interval);
                        button.textContent = translations[currentLang].use_btn;
                        button.disabled = false;
                        nicknameInput.disabled = false;
                        expireEl.textContent = '--:--:--';
                        state.endTime = null;
                        state.interval = null;
                        saveResurrectionState();
                        return;
                    }
                    const remainingMinutes = Math.floor(diff / 1000 / 60);
                    const remainingSeconds = Math.floor(diff / 1000) % 60;
                    button.textContent = `${String(remainingMinutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
                }, 1000);
            }

            resMinusBtn.addEventListener('click', () => { 
                if (resCount > 1) { 
                    const resIdToRemove = `res-${resCount}`;
                    if(resurrectionStates[resIdToRemove] && resurrectionStates[resIdToRemove].interval) {
                        clearInterval(resurrectionStates[resIdToRemove].interval);
                    }
                    delete resurrectionStates[resIdToRemove];
                    resCount--; 
                    resCountEl.textContent = resCount; 
                    updateResurrectionButtons(); 
                } 
            });
            resPlusBtn.addEventListener('click', () => { 
                if (resCount < 10) { 
                    resCount++; 
                    resCountEl.textContent = resCount; 
                    updateResurrectionButtons(); 
                } 
            });
            
            // --- 파티 관리 로직 ---
            const partyListInput = document.getElementById('party-list-input');
            const generateListBtn = document.getElementById('generate-list-btn');
            const resetListBtn = document.getElementById('reset-list-btn');
            const waitingListEl = document.getElementById('waiting-list');
            const partyContainer = document.getElementById('party-container');
            const copyListBtn = document.getElementById('copy-list-btn');
            const copyFeedback = document.getElementById('copy-feedback');
            const partyMinusBtn = document.getElementById('party-minus-btn');
            const partyPlusBtn = document.getElementById('party-plus-btn');
            const partyCountDisplay = document.getElementById('party-count-display');
            
            let partyCount = 4;
            const MAX_PARTIES = 8;
            const MIN_PARTIES = 1;

            const sortableOptions = { group: 'party', animation: 150, ghostClass: 'sortable-ghost' };
            new Sortable(waitingListEl, sortableOptions);

            function createDraggableItem(name, id) {
                const item = document.createElement('div');
                item.className = 'draggable-item';
                item.dataset.id = id;
                const nameSpan = document.createElement('span');
                nameSpan.textContent = name.trim();
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'flex items-center';
                const timerDisplay = document.createElement('span');
                timerDisplay.className = 'death-timer-display';
                const deathBtn = document.createElement('button');
                deathBtn.className = 'btn btn-death';
                deathBtn.textContent = translations[currentLang].death_btn;
                controlsDiv.append(timerDisplay, deathBtn);
                item.append(nameSpan, controlsDiv);
                return item;
            }

            document.querySelector('.w-full.max-w-screen-2xl').addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-death')) {
                    const item = e.target.closest('.draggable-item');
                    const memberId = item.dataset.id;
                    const display = item.querySelector('.death-timer-display');
                    if (deathTimers[memberId]) return;
                    e.target.disabled = true;
                    const endTime = Date.now() + 15 * 60 * 1000;
                    deathTimers[memberId] = {
                        endTime,
                        interval: setInterval(() => {
                            const diff = deathTimers[memberId].endTime - Date.now();
                            if (diff <= 0) {
                                clearInterval(deathTimers[memberId].interval);
                                delete deathTimers[memberId];
                                display.textContent = '';
                                e.target.disabled = false;
                                return;
                            }
                            const minutes = Math.floor((diff / 1000 / 60) % 60);
                            const seconds = Math.floor((diff / 1000) % 60);
                            display.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                        }, 1000)
                    };
                }
            });

            function updatePartyLayout() {
                const memberStates = new Map();
                document.querySelectorAll('.draggable-item').forEach(item => {
                    memberStates.set(item.dataset.id, {
                        name: item.querySelector('span:first-child').textContent,
                        listId: item.parentElement.id
                    });
                });

                if (document.querySelectorAll('#party-container > div').length > partyCount) {
                    const lastPartyId = `party-${document.querySelectorAll('#party-container > div').length}`;
                    document.querySelectorAll(`#${lastPartyId} .draggable-item`).forEach(item => {
                        if (memberStates.has(item.dataset.id)) {
                           memberStates.get(item.dataset.id).listId = 'waiting-list';
                        }
                    });
                }
                
                partyContainer.innerHTML = '';
                for (let i = 1; i <= partyCount; i++) {
                    const partyWrapper = document.createElement('div');
                    partyWrapper.className = 'flex flex-col';
                    const partyTitle = document.createElement('h3');
                    partyTitle.className = 'font-bold text-lg mb-2 text-center';
                    partyTitle.textContent = `${i}${translations[currentLang].party_title}`;
                    const partyList = document.createElement('div');
                    partyList.className = 'party-list';
                    partyList.id = `party-${i}`;
                    partyWrapper.append(partyTitle, partyList);
                    partyContainer.appendChild(partyWrapper);
                    new Sortable(partyList, sortableOptions);
                }
                
                const partyGrid = partyContainer.children.length;
                partyContainer.style.gridTemplateColumns = `repeat(${Math.min(partyGrid, 4)}, 1fr)`;

                waitingListEl.innerHTML = '';
                memberStates.forEach((state, id) => {
                    const targetList = document.getElementById(state.listId) || waitingListEl;
                    targetList.appendChild(createDraggableItem(state.name, id));
                });

                partyCountDisplay.textContent = partyCount;
            }
            
            partyPlusBtn.addEventListener('click', () => { if (partyCount < MAX_PARTIES) { partyCount++; updatePartyLayout(); } });
            partyMinusBtn.addEventListener('click', () => { if (partyCount > MIN_PARTIES) { partyCount--; updatePartyLayout(); } });

            generateListBtn.addEventListener('click', () => {
                const names = partyListInput.value.split('\n').filter(name => name.trim() !== '');
                names.forEach(name => {
                    const uniqueId = `member-${Date.now()}-${Math.random()}`;
                    waitingListEl.appendChild(createDraggableItem(name, uniqueId));
                });
                partyListInput.value = '';
            });

            resetListBtn.addEventListener('click', () => {
                waitingListEl.innerHTML = '';
                document.querySelectorAll('#party-container .party-list').forEach(list => { list.innerHTML = ''; });
                for (const key in deathTimers) {
                    clearInterval(deathTimers[key].interval);
                    delete deathTimers[key];
                }
            });

            copyListBtn.addEventListener('click', () => {
                let fullPartyList = '';
                document.querySelectorAll('#party-container > div').forEach((listWrapper, index) => {
                    const list = listWrapper.querySelector('.party-list');
                    const members = Array.from(list.children).map(item => `- ${item.querySelector("span:first-child").textContent}`);
                    if (members.length > 0) {
                        fullPartyList += `[${index + 1}${translations[currentLang].party_title}]\n${members.join('\n')}\n\n`;
                    }
                });
                const waitingMembers = Array.from(waitingListEl.children).map(item => `- ${item.querySelector("span:first-child").textContent}`);
                if (waitingMembers.length > 0) {
                    fullPartyList += `[${translations[currentLang].waiting_list}]\n${waitingMembers.join('\n')}\n`;
                }
                if (!fullPartyList.trim()) return;
                
                try {
                    navigator.clipboard.writeText(fullPartyList.trim()).then(() => {
                        copyFeedback.style.opacity = '1';
                        setTimeout(() => { copyFeedback.style.opacity = '0'; }, 2000);
                    });
                } catch (err) {
                    const textArea = document.createElement("textarea");
                    textArea.value = fullPartyList.trim();
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        copyFeedback.style.opacity = '1';
                        setTimeout(() => { copyFeedback.style.opacity = '0'; }, 2000);
                    } catch (err) {
                        console.error('Fallback copy failed', err);
                    }
                    document.body.removeChild(textArea);
                }
            });

            // --- 메모장 자동 저장 ---
            const memoPad = document.getElementById('memo-pad');
            function loadMemo() {
                const savedMemo = localStorage.getItem('memoContent');
                if (savedMemo) {
                    memoPad.value = savedMemo;
                }
            }
            function saveMemo() {
                localStorage.setItem('memoContent', memoPad.value);
            }
            memoPad.addEventListener('input', saveMemo);

            // --- 아코디언 (접이식 메뉴) 로직 ---
            function setupAccordions() {
                const accordionItems = document.querySelectorAll('.accordion-item');
                const accordionStates = JSON.parse(localStorage.getItem('accordionStates')) || {};

                accordionItems.forEach(item => {
                    const header = item.querySelector('.accordion-header');
                    const content = item.querySelector('.accordion-content');
                    const targetId = header.dataset.target.substring(1);

                    if (accordionStates[targetId] === 'open') {
                        header.classList.add('active');
                        content.style.maxHeight = content.scrollHeight + "px";
                    }

                    header.addEventListener('click', () => {
                        const isActive = header.classList.contains('active');
                        if (isActive) {
                            header.classList.remove('active');
                            content.style.maxHeight = null;
                            accordionStates[targetId] = 'closed';
                        } else {
                            header.classList.add('active');
                            content.style.maxHeight = content.scrollHeight + "px";
                            accordionStates[targetId] = 'open';
                        }
                        localStorage.setItem('accordionStates', JSON.stringify(accordionStates));
                    });
                });
            }

            // --- 타이머 초기화 로직 ---
            document.getElementById('reset-all-timers').addEventListener('click', () => {
                Object.keys(timers).forEach(id => {
                    clearInterval(timers[id].interval);
                    const button = timers[id].button;
                    const display = timers[id].display;
                    const initialSeconds = timers[id].initialSeconds;
                    
                    display.textContent = formatTime(initialSeconds, id.includes('buff'));
                    button.classList.remove('active');

                    if (id.includes('buff')) {
                        document.getElementById(`${id}-expire`).textContent = '--:--:--';
                    }
                });
                for (const key in timers) { delete timers[key]; }
            });

            document.getElementById('reset-res-timers').addEventListener('click', () => {
                Object.keys(resurrectionStates).forEach(key => {
                    if (resurrectionStates[key] && resurrectionStates[key].interval) {
                        clearInterval(resurrectionStates[key].interval);
                    }
                });
                resurrectionStates = {};
                localStorage.removeItem('resurrectionStates');
                updateResurrectionButtons();
            });

            // --- 초기화 ---
            document.getElementById('lang-ko').addEventListener('click', () => setLanguage('ko'));
            document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
            document.getElementById('lang-ja').addEventListener('click', () => setLanguage('ja'));

            const savedLang = localStorage.getItem('language') || 'ko';
            setLanguage(savedLang);

            loadResurrectionState();
            updateResurrectionButtons();
            updatePartyLayout();
            loadMemo();
            setupAccordions();
        });
    </script>
</body>
</html>
