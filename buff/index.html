<!-- ... 기존 HTML ... -->
<script type="module">
/**
 * 버피(Buffy) 앱 메인 모듈
 * - 타이머, 시계, 음성 안내, 메모장 등 모든 UI 및 상태 관리
 * - 각 기능별로 클래스로 분리
 * - 한글 주석 포함
 */

// ====== 유틸리티 함수 모듈 ======
const Utils = {
    // 시:분:초 포맷 변환
    formatTime(seconds) {
        const totalSeconds = Math.floor(seconds);
        const hours = Math.floor(totalSeconds / 3600);
        const mins = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
        const secs = (totalSeconds % 60).toString().padStart(2, '0');
        if (hours > 0) return `${hours.toString().padStart(2, '0')}:${mins}:${secs}`;
        return `${mins}:${secs}`;
    },
    // 1시간 뒤 시각 문자열 반환
    getOneHourLaterString() {
        const now = new Date();
        now.setHours(now.getHours() + 1);
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }
};

// ====== 음성 안내 모듈 ======
class TTS {
    constructor() {
        this.synth = window.speechSynthesis;
        this.voices = [];
        this.populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => this.populateVoiceList();
        }
    }
    // 한국어 음성 목록만 저장
    populateVoiceList() {
        this.voices = this.synth.getVoices().filter(voice => voice.lang.startsWith('ko'));
    }
    // 음성 안내 실행
    speak(text) {
        if (this.synth.speaking || !text) return;
        const utterThis = new SpeechSynthesisUtterance(text);
        const koreanVoice = this.voices.find(voice => voice.lang === 'ko-KR');
        if (koreanVoice) utterThis.voice = koreanVoice;
        this.synth.speak(utterThis);
    }
}

// ====== 타이머 관리 모듈 ======
class TimerManager {
    constructor({container, tts, onAllTimersRemoved}) {
        this.activeTimers = [];
        this.container = container;
        this.tts = tts;
        this.onAllTimersRemoved = onAllTimersRemoved;
    }
    // 타이머 추가
    addTimer(name, duration, ttsMsg, color = '#4fd1c5') {
        const existing = this.activeTimers.find(t => t.name === name);
        if (existing) {
            existing.originalTotalSeconds = duration;
            existing.totalSeconds = duration;
            existing.secondsLeft = duration;
            this.updateTimerDisplay(existing.id);
            this.tts.speak(`${name} 타이머가 초기화되었습니다.`);
            return;
        }
        const timer = {
            id: `timer-${Date.now()}`,
            name,
            originalTotalSeconds: duration,
            totalSeconds: duration,
            secondsLeft: duration,
            ttsMessage: ttsMsg,
            color
        };
        this.activeTimers.push(timer);
        this.createTimerElement(timer);
        this.updateNoTimersMessage();
    }
    // 타이머 삭제
    removeTimer(timerId) {
        this.activeTimers = this.activeTimers.filter(t => t.id !== timerId);
        const el = document.getElementById(timerId);
        if (el) {
            el.style.opacity = 0;
            setTimeout(() => el.remove(), 300);
        }
        this.updateNoTimersMessage();
        if (this.activeTimers.length === 0 && this.onAllTimersRemoved) {
            this.onAllTimersRemoved();
        }
    }
    // 타이머 시간 조정
    adjustTimer(timerId, amount) {
        const timer = this.activeTimers.find(t => t.id === timerId);
        if (!timer) return;
        timer.secondsLeft += amount;
        timer.totalSeconds += amount;
        if (timer.secondsLeft < 0) timer.secondsLeft = 0;
        if (timer.totalSeconds < 0) timer.totalSeconds = 0;
        this.updateTimerDisplay(timer.id);
    }
    // 모든 타이머 리셋
    resetAllTimers() {
        this.activeTimers.forEach(timer => {
            timer.totalSeconds = timer.originalTotalSeconds;
            timer.secondsLeft = timer.originalTotalSeconds;
            this.updateTimerDisplay(timer.id);
        });
        if (this.activeTimers.length > 0) this.tts.speak("모든 타이머를 초기화했습니다.");
    }
    // 타이머 1초씩 감소 및 음성 안내
    tickAllTimers() {
        this.activeTimers.forEach(timer => {
            if (timer.secondsLeft > 0) {
                timer.secondsLeft--;
            } else {
                this.tts.speak(timer.ttsMessage || `${timer.name} 스킬을 사용할 시간입니다.`);
                timer.secondsLeft = timer.totalSeconds;
            }
            this.updateTimerDisplay(timer.id);
        });
    }
    // 타이머 카드 UI 생성
    createTimerElement(timer) {
        const card = document.createElement('div');
        card.id = timer.id;
        card.className = 'timer-card p-3 rounded-lg shadow-lg flex flex-col space-y-2';
        const iconSVG = timer.name === '홀리심볼'
            ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L12 22M22 12L2 12"/></svg>`
            : timer.name.includes('샤프')
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-teal-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>`;
        card.innerHTML = `
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    ${iconSVG}
                    <span class="font-bold text-md text-white">${timer.name}</span>
                </div>
                <button data-timer-id="${timer.id}" class="remove-btn text-gray-500 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <div class="flex justify-between items-end">
                <span class="time-left font-mono text-3xl font-bold text-white">${Utils.formatTime(timer.secondsLeft)}</span>
                <div class="grid grid-cols-2 gap-1 w-24">
                    <button data-timer-id="${timer.id}" data-amount="-1" class="adjust-time-btn btn bg-red-700 hover:bg-red-600 text-white font-bold rounded-md h-6 flex items-center justify-center text-xs">-1s</button>
                    <button data-timer-id="${timer.id}" data-amount="1" class="adjust-time-btn btn bg-green-700 hover:bg-green-600 text-white font-bold rounded-md h-6 flex items-center justify-center text-xs">+1s</button>
                    <button data-timer-id="${timer.id}" data-amount="-10" class="adjust-time-btn btn bg-red-800 hover:bg-red-700 text-white font-bold rounded-md h-6 flex items-center justify-center text-xs">-10s</button>
                    <button data-timer-id="${timer.id}" data-amount="10" class="adjust-time-btn btn bg-green-800 hover:bg-green-700 text-white font-bold rounded-md h-6 flex items-center justify-center text-xs">+10s</button>
                </div>
            </div>
            <div class="w-full bg-black/30 rounded-full h-1.5 mt-1">
                <div class="progress-bar-inner h-1.5 rounded-full" style="width: 100%; --progress-color: ${timer.color}; background-color: ${timer.color};"></div>
            </div>
        `;
        this.container.appendChild(card);
    }
    // 타이머 UI 갱신
    updateTimerDisplay(timerId) {
        const timer = this.activeTimers.find(t => t.id === timerId);
        const timerElement = document.getElementById(timerId);
        if (timer && timerElement) {
            timerElement.querySelector('.time-left').textContent = Utils.formatTime(timer.secondsLeft);
            const progressPercentage = (timer.secondsLeft / timer.totalSeconds) * 100;
            timerElement.querySelector('.progress-bar-inner').style.width = `${progressPercentage}%`;
        }
    }
    // 타이머 없을 때 메시지 표시
    updateNoTimersMessage() {
        const msg = document.getElementById('no-timers-message');
        if (msg) msg.style.display = this.activeTimers.length === 0 ? 'block' : 'none';
    }
}

// ====== 시계 및 경과시간 모듈 ======
class ClockAndElapsed {
    constructor({clockDisplay, elapsedTimeDisplay}) {
        this.clockDisplay = clockDisplay;
        this.elapsedTimeDisplay = elapsedTimeDisplay;
        this.clockInterval = null;
        this.elapsedTimeInterval = null;
        this.elapsedTime = 0;
    }
    // 실시간 시계 시작
    startClock() {
        if (this.clockInterval) clearInterval(this.clockInterval);
        this.clockInterval = setInterval(() => this.updateClock(), 1000);
        this.updateClock();
    }
    updateClock() {
        if (!this.clockDisplay) return;
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        this.clockDisplay.textContent = `${hours}:${minutes}:${seconds}`;
    }
    // 경과시간 타이머 시작
    startElapsedTimer() {
        this.elapsedTime = 0;
        this.elapsedTimeDisplay.textContent = `경과 시간: 00:00`;
        this.elapsedTimeInterval = setInterval(() => {
            this.elapsedTime++;
            this.elapsedTimeDisplay.textContent = `경과 시간: ${Utils.formatTime(this.elapsedTime)}`;
        }, 1000);
    }
    // 경과시간 타이머 정지
    stopElapsedTimer() {
        clearInterval(this.elapsedTimeInterval);
        this.elapsedTimeDisplay.textContent = '';
    }
}

// ====== 시전 타이머(스톱워치) 모듈 ======
class CastStopwatch {
    constructor({display, toggleBtn, resetBtn, toggleText}) {
        this.display = display;
        this.toggleBtn = toggleBtn;
        this.resetBtn = resetBtn;
        this.toggleText = toggleText;
        this.isRunning = false;
        this.startTime = 0;
        this.interval = null;
        this.init();
    }
    init() {
        if (this.toggleBtn) this.toggleBtn.addEventListener('click', () => this.toggle());
        if (this.resetBtn) this.resetBtn.addEventListener('click', () => this.reset());
    }
    toggle() {
        this.isRunning = !this.isRunning;
        if (this.isRunning) {
            this.startTime = performance.now();
            this.interval = setInterval(() => {
                const elapsed = (performance.now() - this.startTime) / 1000;
                this.display.innerHTML = `${elapsed.toFixed(2)}<span class="text-3xl opacity-70">s</span>`;
            }, 50);
            this.toggleText.textContent = '기록';
        } else {
            clearInterval(this.interval);
            const elapsed = (performance.now() - this.startTime) / 1000;
            this.display.innerHTML = `${elapsed.toFixed(2)}<span class="text-3xl opacity-70">s</span>`;
            this.toggleText.textContent = '시작';
        }
    }
    reset() {
        if (this.isRunning) this.toggle();
        clearInterval(this.interval);
        this.display.innerHTML = `0.00<span class="text-3xl opacity-70">s</span>`;
        this.toggleText.textContent = '시작';
        this.isRunning = false;
    }
}

// ====== 메모장 모듈 ======
class Notepad {
    constructor({textarea}) {
        this.textarea = textarea;
        this.load();
        if (this.textarea) {
            this.textarea.addEventListener('input', () => this.save());
        }
    }
    load() {
        if (!this.textarea) return;
        const saved = localStorage.getItem('buffyNotepad');
        if (saved) this.textarea.value = saved;
    }
    save() {
        if (!this.textarea) return;
        localStorage.setItem('buffyNotepad', this.textarea.value);
    }
}

// ====== 메인 앱 초기화 ======
document.addEventListener('DOMContentLoaded', () => {
    // DOM 요소 모으기
    const clockDisplay = document.getElementById('realtime-clock');
    const elapsedTimeDisplay = document.getElementById('elapsed-time');
    const expectedEndTimeDisplay = document.getElementById('expected-end-time');
    const globalStartBtn = document.getElementById('global-start-btn');
    const globalStopBtn = document.getElementById('global-stop-btn');
    const globalResetBtn = document.getElementById('global-reset-btn');
    const activeTimersContainer = document.getElementById('active-timers-container');
    const customTimerForm = document.getElementById('custom-timer-form');
    const sharpEyesLevels = document.getElementById('sharp-eyes-levels');
    const addSharpEyesBtn = document.getElementById('add-sharp-eyes');
    const presetHolySymbolBtn = document.getElementById('preset-holy-symbol');
    const castTimeDisplay = document.getElementById('cast-time-display');
    const castTimeToggleBtn = document.getElementById('cast-time-toggle-btn');
    const castTimeResetBtn = document.getElementById('cast-time-reset-btn');
    const castTimeToggleText = document.getElementById('cast-time-toggle-text');
    const notepad = document.getElementById('notepad');

    // 각 기능별 객체 생성
    const tts = new TTS();
    const timerManager = new TimerManager({
        container: activeTimersContainer,
        tts,
        onAllTimersRemoved: () => {
            if (expectedEndTimeDisplay) expectedEndTimeDisplay.textContent = '';
        }
    });
    const clockAndElapsed = new ClockAndElapsed({
        clockDisplay,
        elapsedTimeDisplay
    });
    const castStopwatch = new CastStopwatch({
        display: castTimeDisplay,
        toggleBtn: castTimeToggleBtn,
        resetBtn: castTimeResetBtn,
        toggleText: castTimeToggleText
    });
    const notepadManager = new Notepad({textarea: notepad});

    // 타이머 전체 제어 상태
    let isGlobalTimerRunning = false;
    let globalTimerInterval = null;

    // --- 이벤트 바인딩 ---
    if (globalStartBtn) globalStartBtn.addEventListener('click', () => {
        if (timerManager.activeTimers.length > 0 && !isGlobalTimerRunning) {
            isGlobalTimerRunning = true;
            clockAndElapsed.startElapsedTimer();
            if (!globalTimerInterval) {
                globalTimerInterval = setInterval(() => timerManager.tickAllTimers(), 1000);
            }
            if (expectedEndTimeDisplay) {
                expectedEndTimeDisplay.textContent = `예상 종료 시각: ${Utils.getOneHourLaterString()}`;
            }
            updateGlobalButtonsState();
        }
    });
    if (globalStopBtn) globalStopBtn.addEventListener('click', () => {
        if (isGlobalTimerRunning) {
            isGlobalTimerRunning = false;
            clockAndElapsed.stopElapsedTimer();
            updateGlobalButtonsState();
            if (expectedEndTimeDisplay) expectedEndTimeDisplay.textContent = '';
        }
    });
    if (globalResetBtn) globalResetBtn.addEventListener('click', () => {
        timerManager.resetAllTimers();
        if (expectedEndTimeDisplay) expectedEndTimeDisplay.textContent = '';
    });

    if (presetHolySymbolBtn) presetHolySymbolBtn.addEventListener('click', () =>
        timerManager.addTimer('홀리심볼', 120, '홀리심볼', '#f6e05e')
    );

    if (sharpEyesLevels) sharpEyesLevels.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            const currentActive = sharpEyesLevels.querySelector('.active');
            if (currentActive) currentActive.classList.remove('active');
            e.target.classList.add('active');
        }
    });

    if (addSharpEyesBtn) addSharpEyesBtn.addEventListener('click', () => {
        const selectedLevel = sharpEyesLevels.querySelector('.active');
        if (selectedLevel) {
            const duration = parseInt(selectedLevel.dataset.duration, 10);
            const level = selectedLevel.dataset.level;
            timerManager.addTimer(`샤프 아이즈 Lv.${level}`, duration, '샤프 아이즈', '#68d391');
        }
    });

    if (customTimerForm) customTimerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('custom-name');
        const durationInput = document.getElementById('custom-duration');
        const name = nameInput.value;
        const duration = parseInt(durationInput.value, 10);
        if (name && duration > 0) {
            timerManager.addTimer(name, duration, `${name} 스킬 시간입니다.`);
            customTimerForm.reset();
        }
    });

    if (activeTimersContainer) activeTimersContainer.addEventListener('click', (e) => {
        const removeButton = e.target.closest('.remove-btn');
        if (removeButton) {
            timerManager.removeTimer(removeButton.dataset.timerId);
            return;
        }
        const adjustButton = e.target.closest('.adjust-time-btn');
        if (adjustButton) {
            const timerId = adjustButton.dataset.timerId;
            const amount = parseInt(adjustButton.dataset.amount, 10);
            timerManager.adjustTimer(timerId, amount);
        }
    });

    // 버튼 상태 갱신 함수
    function updateGlobalButtonsState() {
        const hasTimers = timerManager.activeTimers.length > 0;
        globalStartBtn.disabled = !hasTimers || isGlobalTimerRunning;
        globalStopBtn.disabled = !hasTimers || !isGlobalTimerRunning;
        globalResetBtn.disabled = !hasTimers;
    }

    // 앱 시작
    clockAndElapsed.startClock();
    updateGlobalButtonsState();
});
</script>
